<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focus Writer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            height: 100vh;
            overflow: hidden;
        }

        .writing-area {
            width: 100%;
            height: 100vh;
            position: relative;
            transition: margin-left 0.3s ease;
        }

        .writing-area.menu-open {
            margin-left: 350px;
        }

        .editor {
            width: 100%;
            height: 100vh;
            border: none;
            outline: none;
            padding: 60px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 18px;
            line-height: 1.7;
            color: #ffffff;
            background: #1a1a1a;
            resize: none;
            overflow-y: auto;
        }

        .editor:focus {
            outline: none;
        }

        .editor::placeholder {
            color: #555555;
            font-style: normal;
        }

        /* Menu Button */
        .menu-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            color: #ffffff;
            width: 44px;
            height: 44px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: all 0.2s ease;
            opacity: 0.7;
        }

        .menu-button:hover {
            background: #3a3a3a;
            opacity: 1;
        }

        .menu-button .hamburger {
            width: 18px;
            height: 14px;
            position: relative;
        }

        .menu-button .hamburger span {
            display: block;
            height: 2px;
            width: 100%;
            background: #ffffff;
            border-radius: 1px;
            position: absolute;
            transition: all 0.2s ease;
        }

        .menu-button .hamburger span:nth-child(1) { top: 0; }
        .menu-button .hamburger span:nth-child(2) { top: 6px; }
        .menu-button .hamburger span:nth-child(3) { top: 12px; }

        .menu-button.active .hamburger span:nth-child(1) {
            transform: rotate(45deg);
            top: 6px;
        }

        .menu-button.active .hamburger span:nth-child(2) {
            opacity: 0;
        }

        .menu-button.active .hamburger span:nth-child(3) {
            transform: rotate(-45deg);
            top: 6px;
        }

        /* Save Status */
        .save-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            color: #cccccc;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            z-index: 1000;
            opacity: 0.7;
            transition: all 0.2s ease;
        }

        .save-status.saved {
            border-color: #2d5a2d;
            color: #66cc66;
        }

        .save-status.saving {
            border-color: #5a4d2d;
            color: #ccaa66;
        }

        .save-status.backup {
            border-color: #2d4a5a;
            color: #66aacc;
        }

        /* Menu Panel */
        .menu-panel {
            position: fixed;
            top: 0;
            left: -350px;
            width: 350px;
            height: 100vh;
            background: #2a2a2a;
            border-right: 1px solid #3a3a3a;
            z-index: 999;
            transition: left 0.3s ease;
            overflow-y: auto;
        }

        .menu-panel.open {
            left: 0;
        }

        .menu-header {
            padding: 20px;
            border-bottom: 1px solid #3a3a3a;
        }

        .menu-title {
            color: #ffffff;
            font-size: 1.4em;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .menu-subtitle {
            color: #888888;
            font-size: 13px;
        }

        .menu-section {
            padding: 20px;
            border-bottom: 1px solid #3a3a3a;
        }

        .menu-section:last-child {
            border-bottom: none;
        }

        .menu-section h3 {
            color: #ffffff;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .menu-buttons.row {
            flex-direction: row;
            flex-wrap: wrap;
        }

        .menu-button-item {
            background: #3a3a3a;
            border: 1px solid #4a4a4a;
            color: #ffffff;
            padding: 12px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.15s ease;
            text-align: center;
        }

        .menu-button-item:hover {
            background: #4a4a4a;
        }

        .menu-button-item.active {
            background: #ffffff;
            color: #1a1a1a;
            border-color: #ffffff;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
        }

        .stat-item {
            background: #3a3a3a;
            padding: 12px;
            border-radius: 4px;
            text-align: center;
        }

        .stat-number {
            color: #ffffff;
            font-size: 18px;
            font-weight: 600;
            display: block;
        }

        .stat-label {
            color: #888888;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        /* Focus Mode */
        .focus-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0a0a0a;
            z-index: 2000;
            display: none;
            flex-direction: column;
        }

        .focus-mode .editor {
            background: #0a0a0a;
            color: #ffffff;
            font-size: 20px;
            padding: 80px;
            height: 100vh;
        }

        .focus-mode .editor::placeholder {
            color: #444444;
        }

        .focus-exit {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            color: #ffffff;
            padding: 12px 16px;
            border-radius: 4px;
            cursor: pointer;
            z-index: 2001;
            font-size: 13px;
            font-weight: 500;
            opacity: 0.7;
        }

        .focus-exit:hover {
            background: #3a3a3a;
            opacity: 1;
        }

        /* Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 998;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .status-message {
            margin-top: 10px;
            font-size: 12px;
            color: #888888;
            max-height: 100px;
            overflow-y: auto;
            line-height: 1.4;
        }

        .backup-timer {
            margin-top: 8px;
            font-size: 11px;
            color: #666;
        }

        @media (max-width: 768px) {
            .editor {
                padding: 40px 20px;
                font-size: 16px;
            }

            .menu-panel {
                width: 100%;
                left: -100%;
            }

            .writing-area.menu-open {
                margin-left: 0;
            }

            .focus-mode .editor {
                padding: 40px 20px;
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="writing-area" id="writingArea">
        <div class="editor" 
             contenteditable="true" 
             id="editor"
             placeholder="Start writing...">
        </div>
    </div>

    <!-- Menu Button -->
    <button class="menu-button" id="menuButton">
        <div class="hamburger">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </button>

    <!-- Save Status -->
    <div class="save-status saved" id="saveStatus">‚óè Saved</div>

    <!-- Menu Panel -->
    <div class="menu-panel" id="menuPanel">
        <div class="menu-header">
            <div class="menu-title">‚óº Focus Writer</div>
            <div class="menu-subtitle">Distraction-free writing with auto-backup</div>
        </div>

        <div class="menu-section">
            <h3>Format</h3>
            <div class="menu-buttons row">
                <button class="menu-button-item" onclick="formatText('bold')" id="boldBtn">Bold</button>
                <button class="menu-button-item" onclick="formatText('italic')" id="italicBtn">Italic</button>
                <button class="menu-button-item" onclick="formatText('underline')" id="underlineBtn">Underline</button>
            </div>
        </div>

        <div class="menu-section">
            <h3>Auto-Backup</h3>
            <div class="menu-buttons">
                <button class="menu-button-item" onclick="detailedDiagnostic()">üîß Test Setup</button>
                <button class="menu-button-item" onclick="connectGoogleDrive()" id="driveConnectBtn">Connect Drive</button>
                <button class="menu-button-item" onclick="verifyFolderAccess()" id="driveVerifyBtn" style="display: none;">Verify Folder</button>
                <button class="menu-button-item" onclick="resetBackupFile()" id="driveResetBtn" style="display: none;">Reset Backup File</button>
                <button class="menu-button-item" onclick="manualBackup()" id="driveBackupBtn" style="display: none;">Manual Backup</button>
                <button class="menu-button-item" onclick="disconnectGoogleDrive()" id="driveDisconnectBtn" style="display: none;">Disconnect</button>
            </div>
            <div class="status-message" id="driveStatus">Click "Test Setup" to check Google Drive integration<br><br>‚ö†Ô∏è <strong>Important:</strong> Make sure you sign in with the Google account that has access to your target folder. If you have multiple Google accounts, you might need to sign out of others first.</div>
            <div class="backup-timer" id="backupTimer"></div>
        </div>

        <div class="menu-section">
            <h3>Document</h3>
            <div class="menu-buttons">
                <button class="menu-button-item" onclick="newDocument()">New Document</button>
                <button class="menu-button-item" onclick="saveDocument()">Download Text</button>
                <button class="menu-button-item" onclick="debugLocalStorage()">Check Local Save</button>
                <button class="menu-button-item" onclick="toggleFocusMode()">Ultra Focus Mode</button>
            </div>
        </div>

        <div class="menu-section">
            <h3>Statistics</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-number" id="wordCount">0</span>
                    <span class="stat-label">Words</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="charCount">0</span>
                    <span class="stat-label">Characters</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Overlay -->
    <div class="overlay" id="overlay"></div>

    <!-- Focus Mode -->
    <div class="focus-mode" id="focusMode">
        <button class="focus-exit" onclick="toggleFocusMode()">Exit Ultra Focus</button>
        <div class="editor" 
             contenteditable="true" 
             id="focusEditor"
             placeholder="Pure focus. Just you and your words.">
        </div>
    </div>

    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <script>
        // Core variables
        let currentEditor = document.getElementById('editor');
        let focusEditor = document.getElementById('focusEditor');
        let isInFocusMode = false;
        let saveTimeout;
        let isMenuOpen = false;

        // DOM elements
        const saveStatusElement = document.getElementById('saveStatus');
        const menuPanel = document.getElementById('menuPanel');
        const menuButton = document.getElementById('menuButton');
        const overlay = document.getElementById('overlay');
        const writingArea = document.getElementById('writingArea');

        // Google Drive variables
        let isGoogleDriveLoaded = false;
        let isSignedIn = false;
        let accessToken = null;
        let currentFileId = null;
        const CLIENT_ID = '224286904313-js0rh1i530am7s9rle98q6grl92gp3vk.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyCyIueSk6Luj3kbLs2EELibnJ6g4LT7c2o';
        const SCOPES = 'https://www.googleapis.com/auth/drive';
        
        // Target folder ID from the URL
        const TARGET_FOLDER_ID = '1HDSoa7EThzo15nkwWlb2RURzBWNxSIAe';
        const BACKUP_FILE_NAME = 'focus-writer-backup.txt';
        
        // Auto-backup variables
        let autoBackupInterval = null;
        let backupCountdown = null;
        let nextBackupTime = null;
        const BACKUP_INTERVAL = 5 * 60 * 1000; // 5 minutes in milliseconds

        // Menu functionality
        function toggleMenu() {
            console.log('Menu button clicked!');
            isMenuOpen = !isMenuOpen;
            
            menuPanel.classList.toggle('open', isMenuOpen);
            menuButton.classList.toggle('active', isMenuOpen);
            overlay.classList.toggle('active', isMenuOpen);
            writingArea.classList.toggle('menu-open', isMenuOpen);
            
            console.log('Menu open:', isMenuOpen);
        }

        function closeMenu() {
            isMenuOpen = false;
            menuPanel.classList.remove('open');
            menuButton.classList.remove('active');
            overlay.classList.remove('active');
            writingArea.classList.remove('menu-open');
        }

        // Auto-save functionality
        function autoSave() {
            const activeEditor = isInFocusMode ? focusEditor : currentEditor;
            const content = activeEditor.innerHTML;
            
            showSaveStatus('saving');
            
            try {
                // Local save
                window.focusWriterContent = content;
                localStorage.setItem('focusWriterContent', content);
                localStorage.setItem('focusWriterLastSaved', new Date().toISOString());
                console.log('üíæ Auto-saved locally at', new Date().toLocaleTimeString());
                console.log('üìÑ Content length:', content.length);
                
                setTimeout(() => {
                    showSaveStatus('saved');
                }, 500);
            } catch (error) {
                console.error('‚ùå Error saving locally:', error);
                showSaveStatus('error');
            }
        }

        function debouncedAutoSave() {
            clearTimeout(saveTimeout);
            showSaveStatus('saving');
            saveTimeout = setTimeout(autoSave, 1000);
        }

        function showSaveStatus(status) {
            saveStatusElement.className = 'save-status';
            
            switch (status) {
                case 'saving':
                    saveStatusElement.textContent = '‚óè Saving...';
                    saveStatusElement.classList.add('saving');
                    break;
                case 'saved':
                    saveStatusElement.textContent = '‚óè Saved';
                    saveStatusElement.classList.add('saved');
                    break;
                case 'backing-up':
                    saveStatusElement.textContent = '‚óè Backing up...';
                    saveStatusElement.classList.add('backup');
                    break;
                case 'backed-up':
                    saveStatusElement.textContent = '‚óè Backed up';
                    saveStatusElement.classList.add('backup');
                    setTimeout(() => showSaveStatus('saved'), 2000);
                    break;
                case 'error':
                    saveStatusElement.textContent = '‚óè Error';
                    break;
                default:
                    saveStatusElement.textContent = '‚óè Saved';
                    saveStatusElement.classList.add('saved');
            }
        }

        function loadSavedContent() {
            try {
                const savedContent = window.focusWriterContent || localStorage.getItem('focusWriterContent');
                if (savedContent) {
                    currentEditor.innerHTML = savedContent;
                    focusEditor.innerHTML = savedContent;
                    updateStats();
                }
                
                // Load file ID if exists
                currentFileId = localStorage.getItem('focusWriterFileId');
            } catch (error) {
                console.error('Error loading saved content:', error);
            }
        }

        function clearSavedContent() {
            try {
                window.focusWriterContent = null;
                localStorage.removeItem('focusWriterContent');
                localStorage.removeItem('focusWriterLastSaved');
                localStorage.removeItem('focusWriterFileId');
            } catch (error) {
                console.error('Error clearing saved content:', error);
            }
        }

        function syncEditors() {
            if (isInFocusMode) {
                currentEditor.innerHTML = focusEditor.innerHTML;
            } else {
                focusEditor.innerHTML = currentEditor.innerHTML;
            }
            updateStats();
            debouncedAutoSave();
        }

        function updateStats() {
            const activeEditor = isInFocusMode ? focusEditor : currentEditor;
            const text = activeEditor.innerText || activeEditor.textContent || '';
            const words = text.trim() === '' ? 0 : text.trim().split(/\s+/).length;
            const chars = text.length;
            
            document.getElementById('wordCount').textContent = words;
            document.getElementById('charCount').textContent = chars;
        }

        function formatText(command) {
            document.execCommand(command, false, null);
            updateToolbarState();
        }

        function updateToolbarState() {
            const commands = ['bold', 'italic', 'underline'];
            commands.forEach(command => {
                const btn = document.getElementById(command + 'Btn');
                if (btn) {
                    if (document.queryCommandState(command)) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                }
            });
        }

        function toggleFocusMode() {
            const focusMode = document.getElementById('focusMode');
            isInFocusMode = !isInFocusMode;
            
            if (isInFocusMode) {
                syncEditors();
                focusMode.style.display = 'flex';
                focusEditor.focus();
                closeMenu();
            } else {
                syncEditors();
                focusMode.style.display = 'none';
                currentEditor.focus();
            }
        }

        function saveDocument() {
            const activeEditor = isInFocusMode ? focusEditor : currentEditor;
            const plainText = activeEditor.innerText || activeEditor.textContent || '';
            
            const blob = new Blob([plainText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            const now = new Date();
            const timestamp = now.toISOString().slice(0, 16).replace('T', '_').replace(/:/g, '-');
            a.download = `focus-writer_${timestamp}.txt`;
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            closeMenu();
        }

        function newDocument() {
            if (confirm('Start a new document? Any unsaved changes will be lost.')) {
                currentEditor.innerHTML = '';
                focusEditor.innerHTML = '';
                clearSavedContent();
                currentFileId = null;
                updateStats();
                showSaveStatus('saved');
                currentEditor.focus();
                closeMenu();
                
                // Reset backup file ID
                localStorage.removeItem('focusWriterFileId');
            }
        }

        function debugLocalStorage() {
            console.log('=== LOCAL STORAGE DEBUG ===');
            
            try {
                const content = localStorage.getItem('focusWriterContent');
                const lastSaved = localStorage.getItem('focusWriterLastSaved');
                const fileId = localStorage.getItem('focusWriterFileId');
                
                console.log('üíæ Content length:', content ? content.length : 'null');
                console.log('üïí Last saved:', lastSaved || 'never');
                console.log('üÜî File ID:', fileId || 'none');
                console.log('üìù Current editor content length:', currentEditor.innerHTML.length);
                
                alert(`Local Storage Debug:
                
Content stored: ${content ? content.length + ' characters' : 'None'}
Last saved: ${lastSaved || 'Never'}
File ID: ${fileId || 'None'}
Current editor: ${currentEditor.innerHTML.length} characters

Check console (F12) for full details.`);
                
            } catch (error) {
                console.error('‚ùå localStorage error:', error);
                alert('‚ùå Error checking localStorage: ' + error.message);
            }
        }

        function resetBackupFile() {
            console.log('üîÑ Resetting backup file to target folder...');
            currentFileId = null;
            localStorage.removeItem('focusWriterFileId');
            updateDriveStatus('üîÑ Reset complete - next backup will create new file in target folder');
        }

        // Auto-backup timer functions
        function startBackupTimer() {
            if (!isSignedIn) return;
            
            // Clear existing intervals
            if (autoBackupInterval) clearInterval(autoBackupInterval);
            if (backupCountdown) clearInterval(backupCountdown);
            
            nextBackupTime = Date.now() + BACKUP_INTERVAL;
            
            // Main backup interval (every 5 minutes)
            autoBackupInterval = setInterval(() => {
                performAutoBackup();
                nextBackupTime = Date.now() + BACKUP_INTERVAL;
            }, BACKUP_INTERVAL);
            
            // Countdown display (every second)
            backupCountdown = setInterval(updateBackupTimer, 1000);
            
            console.log('üïê Auto-backup started (every 5 minutes)');
        }

        function stopBackupTimer() {
            if (autoBackupInterval) {
                clearInterval(autoBackupInterval);
                autoBackupInterval = null;
            }
            if (backupCountdown) {
                clearInterval(backupCountdown);
                backupCountdown = null;
            }
            document.getElementById('backupTimer').innerHTML = '';
            console.log('üõë Auto-backup stopped');
        }

        function updateBackupTimer() {
            if (!nextBackupTime || !isSignedIn) return;
            
            const timeLeft = Math.max(0, nextBackupTime - Date.now());
            const minutes = Math.floor(timeLeft / 60000);
            const seconds = Math.floor((timeLeft % 60000) / 1000);
            
            document.getElementById('backupTimer').innerHTML = 
                `Next backup in: ${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function performAutoBackup() {
            if (!isSignedIn || !accessToken) {
                console.log('‚ö†Ô∏è Auto-backup skipped - not connected to Drive');
                return;
            }
            
            console.log('üîÑ Performing auto-backup...');
            backupToGoogleDrive(true); // true = silent backup
        }

        // Google Drive Functions
        function updateDriveStatus(message) {
            document.getElementById('driveStatus').innerHTML = message;
        }

        function detailedDiagnostic() {
            updateDriveStatus('üîç Running diagnostic...');
            console.log('=== GOOGLE DRIVE DIAGNOSTIC ===');
            
            let diagnosticResults = [];
            
            // Check 1: Protocol
            if (window.location.protocol === 'file:') {
                diagnosticResults.push('‚ùå File protocol - must use HTTP server');
                updateDriveStatus(diagnosticResults.join('<br>'));
                return;
            }
            
            diagnosticResults.push('‚úÖ HTTP protocol OK: ' + window.location.origin);
            
            // Check 2: Google Identity Services
            if (typeof google === 'undefined') {
                diagnosticResults.push('‚è≥ Loading Google Identity Services...');
                updateDriveStatus(diagnosticResults.join('<br>'));
                
                setTimeout(() => {
                    if (typeof google === 'undefined') {
                        diagnosticResults.push('‚ùå Google Identity Services failed to load');
                        diagnosticResults.push('üîß Try: disable ad blockers, enable cookies');
                    } else {
                        diagnosticResults.push('‚úÖ Google Identity Services loaded');
                        diagnosticResults.push('‚úÖ Setup complete - ready to connect');
                    }
                    updateDriveStatus(diagnosticResults.join('<br>'));
                }, 3000);
            } else {
                diagnosticResults.push('‚úÖ Google Identity Services loaded');
                diagnosticResults.push('üìÅ Target folder: ' + TARGET_FOLDER_ID);
                diagnosticResults.push('üîß Scope: Full Google Drive access');
                diagnosticResults.push('‚úÖ Setup complete - ready to connect');
                updateDriveStatus(diagnosticResults.join('<br>'));
            }
            
            // Check 3: GAPI availability
            loadGAPI().then(() => {
                diagnosticResults.push('‚úÖ Google API client loaded');
                updateDriveStatus(diagnosticResults.join('<br>'));
            }).catch(error => {
                diagnosticResults.push('‚ùå Google API error: ' + error.message);
                updateDriveStatus(diagnosticResults.join('<br>'));
            });
        }

        function verifyFolderAccess() {
            if (!isSignedIn || !accessToken) {
                updateDriveStatus('‚ùå Not connected to Google Drive');
                return;
            }

            updateDriveStatus('üîç Verifying folder access...');
            
            // Try to get folder information
            fetch(`https://www.googleapis.com/drive/v3/files/${TARGET_FOLDER_ID}?fields=id,name,parents,capabilities`, {
                method: 'GET',
                headers: new Headers({
                    'Authorization': `Bearer ${accessToken}`
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error.message);
                }
                
                console.log('üìÅ Folder info:', data);
                let statusMessage = `‚úÖ Folder access verified:<br>üìÅ Name: ${data.name}<br>üÜî ID: ${data.id}`;
                
                if (data.capabilities) {
                    statusMessage += `<br>‚úèÔ∏è Can edit: ${data.capabilities.canEdit || 'unknown'}`;
                    statusMessage += `<br>üìÑ Can add children: ${data.capabilities.canAddChildren || 'unknown'}`;
                }
                
                updateDriveStatus(statusMessage);
            })
            .catch(error => {
                console.error('‚ùå Folder access error:', error);
                updateDriveStatus(`‚ùå Cannot access folder: ${error.message}<br>üîß Make sure you have write access to this folder<br>üîß Try sharing the folder with the Google account you're using`);
            });
        }

        function loadGAPI() {
            return new Promise((resolve, reject) => {
                if (typeof gapi !== 'undefined' && gapi.client) {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://apis.google.com/js/api.js';
                script.onload = () => {
                    gapi.load('client', {
                        callback: () => {
                            gapi.client.init({
                                apiKey: API_KEY,
                                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
                            }).then(resolve).catch(reject);
                        },
                        onerror: reject
                    });
                };
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        function connectGoogleDrive() {
            console.log('üîó Connect Drive button clicked!');
            updateDriveStatus('üîÑ Connecting...');
            
            if (window.location.protocol === 'file:') {
                updateDriveStatus('‚ùå Must run from HTTP server');
                return;
            }
            
            if (typeof google === 'undefined') {
                updateDriveStatus('‚ùå Google Identity Services not loaded<br>üîß Try refreshing page or disabling ad blockers');
                return;
            }
            
            try {
                const client = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    hint: '', // This forces account picker
                    callback: (response) => {
                        console.log('OAuth response:', response);
                        
                        if (response.error) {
                            console.error('OAuth error:', response.error);
                            updateDriveStatus('‚ùå Authentication failed: ' + response.error);
                            return;
                        }
                        
                        if (response.access_token) {
                            accessToken = response.access_token;
                            isSignedIn = true;
                            updateDriveUI();
                            updateDriveStatus('‚úÖ Connected to Google Drive<br>üîÑ Auto-backup every 5 minutes');
                            console.log('‚úÖ Successfully connected to Google Drive');
                            
                            loadGAPI().then(() => {
                                gapi.client.setToken({access_token: accessToken});
                                isGoogleDriveLoaded = true;
                                
                                // Verify folder access first
                                setTimeout(() => {
                                    verifyFolderAccess();
                                    
                                    // Check if current file is in target folder
                                    if (currentFileId) {
                                        verifyCurrentFile().then(isValidFile => {
                                            if (!isValidFile) {
                                                console.log('‚ö†Ô∏è Existing file not in target folder - resetting...');
                                                resetBackupFile();
                                            }
                                            
                                            // Start auto-backup timer after verification
                                            setTimeout(() => {
                                                startBackupTimer();
                                                performAutoBackup();
                                            }, 2000);
                                        });
                                    } else {
                                        // No existing file, start backup timer
                                        setTimeout(() => {
                                            startBackupTimer();
                                            performAutoBackup();
                                        }, 2000);
                                    }
                                }, 1000);
                            });
                        }
                    },
                });
                
                client.requestAccessToken();
                
            } catch (error) {
                console.error('‚ùå Connection error:', error);
                updateDriveStatus('‚ùå Connection failed: ' + error.message);
            }
        }

        function disconnectGoogleDrive() {
            if (accessToken) {
                google.accounts.oauth2.revoke(accessToken, () => {
                    console.log('Token revoked');
                });
            }
            
            // Stop auto-backup
            stopBackupTimer();
            
            accessToken = null;
            isSignedIn = false;
            isGoogleDriveLoaded = false;
            currentFileId = null;
            updateDriveUI();
            updateDriveStatus('Disconnected from Google Drive');
        }

        function manualBackup() {
            backupToGoogleDrive(false); // false = show feedback
        }

        function verifyCurrentFile() {
            if (!currentFileId || !isSignedIn || !accessToken) {
                return Promise.resolve(false);
            }

            return fetch(`https://www.googleapis.com/drive/v3/files/${currentFileId}?fields=id,name,parents`, {
                method: 'GET',
                headers: new Headers({
                    'Authorization': `Bearer ${accessToken}`
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.log('‚ùå Current file not found:', data.error.message);
                    return false;
                }
                
                console.log('üìÑ Current file info:', data);
                
                // Check if file is in target folder
                const isInTargetFolder = data.parents && data.parents.includes(TARGET_FOLDER_ID);
                console.log('üìÅ Is in target folder:', isInTargetFolder);
                
                if (!isInTargetFolder) {
                    console.log('‚ö†Ô∏è Current file is NOT in target folder. Parents:', data.parents);
                    console.log('üéØ Target folder:', TARGET_FOLDER_ID);
                    return false;
                }
                
                return true;
            })
            .catch(error => {
                console.error('‚ùå Error verifying current file:', error);
                return false;
            });
        }

        function backupToGoogleDrive(silent = false) {
            if (!isSignedIn || !accessToken) {
                if (!silent) updateDriveStatus('‚ùå Not connected to Google Drive');
                return;
            }
            
            if (!silent) {
                updateDriveStatus('üíæ Backing up to Google Drive...');
                showSaveStatus('backing-up');
            }
            
            const activeEditor = isInFocusMode ? focusEditor : currentEditor;
            const content = activeEditor.innerText || activeEditor.textContent || '';
            
            // Always save locally first
            localStorage.setItem('focusWriterContent', activeEditor.innerHTML);
            localStorage.setItem('focusWriterLastSaved', new Date().toISOString());
            console.log('üíæ Saved locally to localStorage');
            
            // Verify current file is in target folder before updating
            verifyCurrentFile().then(isValidFile => {
                if (currentFileId && isValidFile) {
                    // Update existing file
                    updateFileInDrive(content, silent);
                } else {
                    // Create new file (either no file ID or file not in target folder)
                    if (currentFileId && !isValidFile) {
                        console.log('üîÑ Current file not in target folder, creating new file...');
                        currentFileId = null;
                        localStorage.removeItem('focusWriterFileId');
                    }
                    createFileInDrive(content, silent);
                }
            });
        }

        function createFileInDrive(content, silent) {
            const fileMetadata = {
                name: BACKUP_FILE_NAME,
                parents: [TARGET_FOLDER_ID]
            };
            
            console.log('üì§ Creating file in Drive folder:', TARGET_FOLDER_ID);
            
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(fileMetadata)], {type: 'application/json'}));
            form.append('file', new Blob([content], {type: 'text/plain'}));
            
            fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,parents,webViewLink', {
                method: 'POST',
                headers: new Headers({
                    'Authorization': `Bearer ${accessToken}`
                }),
                body: form
            })
            .then(response => {
                console.log('üì° Drive API response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('üì° Drive API response data:', data);
                
                if (data.error) {
                    throw new Error(data.error.message);
                }
                
                currentFileId = data.id;
                localStorage.setItem('focusWriterFileId', currentFileId);
                
                if (!silent) {
                    updateDriveStatus(`‚úÖ Backup created: ${BACKUP_FILE_NAME}<br>üìÅ Folder: ${TARGET_FOLDER_ID}<br>üîó File ID: ${data.id}<br>üìç Parents: ${JSON.stringify(data.parents)}`);
                    showSaveStatus('backed-up');
                }
                console.log('‚úÖ File created in Google Drive:', data);
            })
            .catch(error => {
                console.error('‚ùå Backup error details:', error);
                if (!silent) {
                    updateDriveStatus(`‚ùå Backup failed: ${error.message}<br>üîß Check console for details<br>üìÅ Target folder: ${TARGET_FOLDER_ID}`);
                    showSaveStatus('error');
                }
            });
        }

        function updateFileInDrive(content, silent) {
            console.log('üìù Updating existing file:', currentFileId);
            
            fetch(`https://www.googleapis.com/upload/drive/v3/files/${currentFileId}?uploadType=media&fields=id,name,modifiedTime`, {
                method: 'PATCH',
                headers: new Headers({
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'text/plain'
                }),
                body: content
            })
            .then(response => {
                console.log('üì° Update response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('üì° Update response data:', data);
                
                if (data.error) {
                    throw new Error(data.error.message);
                }
                
                if (!silent) {
                    updateDriveStatus(`‚úÖ Backup updated: ${BACKUP_FILE_NAME}<br>üìÅ Last updated: ${new Date().toLocaleTimeString()}<br>üÜî File ID: ${data.id}`);
                    showSaveStatus('backed-up');
                }
                console.log('‚úÖ File updated in Google Drive:', data);
            })
            .catch(error => {
                console.error('‚ùå Update error details:', error);
                // If file doesn't exist, create a new one
                if (error.message.includes('404') || error.message.includes('File not found')) {
                    console.log('üîÑ File not found, creating new one...');
                    currentFileId = null;
                    localStorage.removeItem('focusWriterFileId');
                    createFileInDrive(content, silent);
                } else {
                    if (!silent) {
                        updateDriveStatus(`‚ùå Backup update failed: ${error.message}<br>üîß Check console for details`);
                        showSaveStatus('error');
                    }
                }
            });
        }

        function updateDriveUI() {
            const connectBtn = document.getElementById('driveConnectBtn');
            const disconnectBtn = document.getElementById('driveDisconnectBtn');
            const backupBtn = document.getElementById('driveBackupBtn');
            const verifyBtn = document.getElementById('driveVerifyBtn');
            const resetBtn = document.getElementById('driveResetBtn');
            
            if (isSignedIn) {
                connectBtn.style.display = 'none';
                disconnectBtn.style.display = 'block';
                backupBtn.style.display = 'block';
                verifyBtn.style.display = 'block';
                resetBtn.style.display = 'block';
            } else {
                connectBtn.style.display = 'block';
                disconnectBtn.style.display = 'none';
                backupBtn.style.display = 'none';
                verifyBtn.style.display = 'none';
                resetBtn.style.display = 'none';
            }
        }

        // Event listeners
        menuButton.addEventListener('click', toggleMenu);
        overlay.addEventListener('click', closeMenu);

        currentEditor.addEventListener('input', syncEditors);
        focusEditor.addEventListener('input', syncEditors);
        
        currentEditor.addEventListener('keyup', updateToolbarState);
        focusEditor.addEventListener('keyup', updateToolbarState);
        
        currentEditor.addEventListener('mouseup', updateToolbarState);
        focusEditor.addEventListener('mouseup', updateToolbarState);

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (isInFocusMode) {
                    toggleFocusMode();
                } else if (isMenuOpen) {
                    closeMenu();
                }
            }
            
            if (e.ctrlKey && e.key === 'm') {
                e.preventDefault();
                toggleMenu();
            }
            
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                if (isSignedIn) {
                    manualBackup();
                } else {
                    saveDocument();
                }
            }
            
            if (e.ctrlKey && e.key === 'b') {
                e.preventDefault();
                formatText('bold');
            }
            
            if (e.ctrlKey && e.key === 'i') {
                e.preventDefault();
                formatText('italic');
            }
            
            if (e.ctrlKey && e.key === 'u') {
                e.preventDefault();
                formatText('underline');
            }
        });

        // Initialize
        console.log('Initializing Focus Writer with Auto-Backup...');
        
        loadSavedContent();
        
        // Start cursor on third line if no saved content
        if (!window.focusWriterContent && !localStorage.getItem('focusWriterContent')) {
            currentEditor.innerHTML = '<br><br>';
            focusEditor.innerHTML = '<br><br>';
            
            const range = document.createRange();
            const selection = window.getSelection();
            range.setStart(currentEditor, 2);
            range.collapse(true);
            selection.removeAllRanges();
            selection.addRange(range);
        }
        
        updateStats();
        showSaveStatus('saved');
        currentEditor.focus();
        
        console.log('Focus Writer initialized successfully!');
        console.log('Target Google Drive folder:', TARGET_FOLDER_ID);
    </script>
</body>
</html>